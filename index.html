<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Monitoreo Backups</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter,Arial;background:#0b1220;color:#e5e7eb}
header{background:#020617;padding:16px;font-size:18px;color:#38bdf8}
.container{padding:20px}
.card{background:#020617;border:1px solid #1f2a3d;border-radius:12px;padding:16px;margin-bottom:16px}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
button{background:#0ea5e9;border:none;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
canvas{max-height:260px}
.kpi{flex:1;min-width:200px;background:#020617;border:1px solid #1f2a3d;border-radius:12px;padding:14px}
.kpi h2{margin:0;font-size:22px}
.kpi span{font-size:12px;color:#94a3b8}
table{width:100%;border-collapse:collapse;font-family:Consolas;font-size:12px}
th,td{border-bottom:1px solid #1f2a3d;padding:6px;white-space:nowrap}
</style>
</head>

<body>
<header>Dashboard – Monitoreo de Backups</header>

<div class="container">

<!-- FILTROS -->
<div class="card flex">
  <input type="file" accept=".csv" multiple onchange="loadCSV(event)">
  <select id="filterClient"></select>
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <select id="unitSelect" onchange="renderAll()">
    <option value="MB">MB</option>
    <option value="GB" selected>GB</option>
    <option value="TB">TB</option>
  </select>
  <button onclick="applyFilters()">Aplicar</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<!-- KPIs -->
<div class="flex">
  <div class="kpi"><span>Ejecuciones</span><h2 id="kpiRuns">0</h2></div>
  <div class="kpi"><span>Archivos Copiados</span><h2 id="kpiFiles">0</h2></div>
  <div class="kpi"><span>Datos Transferidos</span><h2 id="kpiBytes">0</h2></div>
  <div class="kpi"><span>Clientes Críticos</span><h2 id="kpiCrit">0</h2></div>
</div>

<!-- GRAFICAS -->
<div class="card"><h3>Backups por día</h3><canvas id="runsDayChart"></canvas></div>
<div class="card"><h3>Bytes copiados por día</h3><canvas id="bytesDayChart"></canvas></div>

<div class="card">
  <h3>Ejecuciones por cliente (click para filtrar)</h3>
  <canvas id="runsClientChart"></canvas>
</div>

<div class="card">
  <h3>Duración promedio por cliente (min)</h3>
  <canvas id="durationClientChart"></canvas>
</div>

<!-- HISTORICO -->
<div class="card">
<h3>Histórico completo</h3>
<table>
<thead id="csvHead"></thead>
<tbody id="csvBody"></tbody>
</table>
</div>

</div>

<script>
let raw = [], data = [], charts = {};

// ================== HELPERS ==================
function normalizeDate(v){
  const d = new Date(v);
  return isNaN(d) ? v.slice(0,10) : d.toISOString().slice(0,10);
}

function durationToSeconds(v){
  if(!v) return 0;
  if(!isNaN(v)) return Number(v);
  const p = v.split(':').map(Number);
  if(p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
  if(p.length === 2) return p[0]*60 + p[1];
  return 0;
}

function parseCSVLine(line){
  const re = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
  return line.split(re).map(v=>v.replace(/^"|"$/g,''));
}

// ================== LOAD CSV ==================
function loadCSV(e){
  raw = [];
  Promise.all([...e.target.files].map(f=>f.text())).then(txts=>{
    txts.forEach(t=>{
      const lines = t.split(/\r?\n/).filter(Boolean);
      const headers = parseCSVLine(lines[0]);
      lines.slice(1).forEach(l=>{
        const values = parseCSVLine(l);
        const o = {};
        headers.forEach((h,i)=>{
          o[h] = values[i];
          if(h === 'Fecha') o[h] = normalizeDate(values[i]);
        });
        raw.push(o);
      });
    });
    initFilters();
    applyFilters();
  });
}

// ================== FILTROS ==================
function initFilters(){
  filterClient.innerHTML =
    '<option value="">Todos</option>' +
    [...new Set(raw.map(r=>r.Cliente))]
      .map(c=>`<option>${c}</option>`).join('');
}

function applyFilters(){
  data = raw.filter(r=>{
    if(filterClient.value && r.Cliente !== filterClient.value) return false;
    if(fromDate.value && r.Fecha < fromDate.value) return false;
    if(toDate.value && r.Fecha > toDate.value) return false;
    return true;
  });
  renderAll();
}

function resetFilters(){
  filterClient.value='';
  fromDate.value='';
  toDate.value='';
  applyFilters();
}

// ================== RENDER ==================
function renderAll(){
  renderKPIs();
  renderCharts();
  renderTable();
}

function renderKPIs(){
  const unit = unitSelect.value;
  const factor = {MB:1024**2,GB:1024**3,TB:1024**4}[unit];

  kpiRuns.textContent = data.length;
  kpiFiles.textContent = data.reduce((s,r)=>s+Number(r.ArchivosCopiados||0),0);
  kpiBytes.textContent =
    (data.reduce((s,r)=>s+Number(r.BytesCopiados||0),0)/factor).toFixed(2)+' '+unit;

  kpiCrit.textContent = [...new Set(
    data.filter(r=>r.Estado!=='OK'||Number(r.DiasSinCopia)>=3)
        .map(r=>r.Cliente)
  )].length;
}

function renderCharts(){
  Object.values(charts).forEach(c=>c&&c.destroy());
  charts = {};

  const unit = unitSelect.value;
  const factor = {MB:1024**2,GB:1024**3,TB:1024**4}[unit];

  const runsDay={}, bytesDay={}, runsClient={}, durClient={};

  data.forEach(r=>{
    runsDay[r.Fecha]=(runsDay[r.Fecha]||0)+1;
    bytesDay[r.Fecha]=(bytesDay[r.Fecha]||0)+Number(r.BytesCopiados||0);
    runsClient[r.Cliente]=(runsClient[r.Cliente]||0)+1;

    const sec = durationToSeconds(r.Duracion);
    if(sec>0){
      durClient[r.Cliente]=(durClient[r.Cliente]||[]).concat(sec);
    }
  });

  const days = Object.keys(runsDay).sort();

  charts.runsDay = new Chart(runsDayChart,{
    type:'bar',
    data:{labels:days,datasets:[{label:'Ejecuciones',data:days.map(d=>runsDay[d]),backgroundColor:'#38bdf8'}]}
  });

  charts.bytesDay = new Chart(bytesDayChart,{
    type:'line',
    data:{labels:days,datasets:[{label:`Datos (${unit})`,data:days.map(d=>bytesDay[d]/factor),borderColor:'#22c55e',tension:.3}]}
  });

  // ✅ CAMBIO A PIE CHART
  charts.runsClient = new Chart(runsClientChart,{
    type:'pie',
    data:{
      labels:Object.keys(runsClient),
      datasets:[{
        data:Object.values(runsClient),
        backgroundColor:[
          '#38bdf8','#a855f7','#22c55e','#f97316',
          '#ef4444','#14b8a6','#eab308','#6366f1'
        ]
      }]
    },
    options:{
      onClick:(e,els)=>{
        if(!els.length) return;
        filterClient.value =
          charts.runsClient.data.labels[els[0].index];
        applyFilters();
      }
    }
  });

  charts.durationClient = new Chart(durationClientChart,{
    type:'bar',
    data:{labels:Object.keys(durClient),
      datasets:[{label:'Duración promedio (min)',
      data:Object.values(durClient)
        .map(a => (a.reduce((x,y)=>x+y,0)/a.length)/60),
      backgroundColor:'#f97316'}]}
  });
}

function renderTable(){
  if(!data.length) return;
  const h = Object.keys(data[0]);
  csvHead.innerHTML='<tr>'+h.map(x=>`<th>${x}</th>`).join('')+'</tr>';
  csvBody.innerHTML=data.map(r=>
    '<tr>'+h.map(k=>`<td>${r[k]}</td>`).join('')+'</tr>'
  ).join('');
}
</script>
</body>
</html>
