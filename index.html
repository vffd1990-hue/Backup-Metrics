<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>M√©tricas Backups</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>



<style>
body{margin:0;font-family:Inter,Arial;background:#0b1220;color:#e5e7eb}
header{background:#020617;padding:16px;font-size:18px;color:#38bdf8}
.container{padding:20px}
.card{background:#020617;border:1px solid #1f2a3d;border-radius:12px;padding:16px;margin-bottom:16px}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
button{background:#0ea5e9;border:none;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
canvas{max-height:260px}
.kpi{flex:1;min-width:200px;background:#020617;border:1px solid #1f2a3d;border-radius:12px;padding:14px}
.kpi h2{margin:0;font-size:22px}
.kpi span{font-size:12px;color:#94a3b8}
table{width:100%;border-collapse:collapse;font-family:Consolas;font-size:12px}
th,td{border-bottom:1px solid #1f2a3d;padding:6px;white-space:nowrap}

/* ===== ESTADO VISUAL DE FILAS (HIST√ìRICO) ===== */
tr.row-ok {
  background-color: rgba(34,197,94,0.15);
  color: #bbf7d0;
}

tr.row-warning {
  background-color: rgba(234,179,8,0.20);
  color: #fde68a;
}

tr.row-critical {
  background-color: rgba(239,68,68,0.25);
  color: #fecaca;
  font-weight: 600;
}

tr.row-ok:hover,
tr.row-warning:hover,
tr.row-critical:hover {
  filter: brightness(1.15);
}


/* ===== TABLA TOP 10 (alineaci√≥n fija) ===== */
.table-top10 {
  table-layout: fixed;
  width: 100%;
}

.table-top10 th,
.table-top10 td {
  text-align: left;
}

.table-top10 th:nth-child(1),
.table-top10 td:nth-child(1) {
  width: 40px;
  text-align: center;
}

.table-top10 th:nth-child(2),
.table-top10 td:nth-child(2) {
  width: 120px;
}

.table-top10 th:nth-child(3),
.table-top10 td:nth-child(3) {
  width: 220px;
}

.table-top10 th:nth-child(4),
.table-top10 td:nth-child(4) {
  width: 140px;
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum";
}

/* ===== HIST√ìRICO CON SCROLL ===== */
.historico-wrapper {
  max-height: 650px;
  overflow-y: auto;
  overflow-x: auto;   /* üëà CLAVE */
  border: 1px solid #1f2a3d;
  border-radius: 8px;
}


/* bot√≥n copiar */
.copy-btn {
  background: #020617;
  border: 1px solid #334155;
  color: #38bdf8;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
}
.copy-btn:hover {
  background: #0b1220;
}

/* ===== HIST√ìRICO: THEAD FIJO + TBODY SCROLL ===== */
.historico-table {
  width: 100%;
  border-collapse: collapse;
}

.historico-table {
  width: max-content;   /* üëà CLAVE */
  min-width: 100%;
  border-collapse: collapse;
}

.historico-table th,
.historico-table td {
  padding: 6px 10px;
  white-space: nowrap;
}


/* ===== ANCHOS HIST√ìRICO ===== */
.historico-table th,
.historico-table td {
  padding: 6px 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.historico-table th:nth-child(1),
.historico-table td:nth-child(1) {
  width: 40px;
  text-align: center;
}

.historico-table th:nth-child(2),
.historico-table td:nth-child(2) {
  width: 110px; /* Fecha */
}

.historico-table th:nth-child(3),
.historico-table td:nth-child(3) {
  width: 160px; /* Inicio */
}

.historico-table th:nth-child(4),
.historico-table td:nth-child(4) {
  width: 160px; /* Fin */
}

.historico-table th:nth-child(5),
.historico-table td:nth-child(5) {
  width: 120px; /* Duracion */
}

.historico-table th:nth-child(6),
.historico-table td:nth-child(6) {
  width: 140px; /* Cliente */
}

.historico-table th:nth-child(7),
.historico-table td:nth-child(7) {
  width: 220px; /* Tarea */
}

.historico-table th:nth-child(8),
.historico-table td:nth-child(8) {
  width: 120px; /* TipoCopia */
}

.historico-table th:nth-child(9),
.historico-table td:nth-child(9) {
  width: 90px; /* Estado */
  text-align: center;
}

.historico-table th:nth-child(10),
.historico-table td:nth-child(10),
.historico-table th:nth-child(11),
.historico-table td:nth-child(11),
.historico-table th:nth-child(12),
.historico-table td:nth-child(12) {
  width: 120px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}


</style>
</head>

<body>
<header>M√©tricas de respaldos</header>

<div class="container">

<div class="card flex">
  <input type="file" accept=".csv" multiple onchange="loadCSV(event)">
  <select id="filterClient"></select>
  <select id="filterTask"></select>
<select id="filterCopyType"></select>
  <input type="date" id="fromDate" title="Fecha de inicio">
<input type="date" id="toDate" title="Fecha final">
  <select id="unitSelect" onchange="renderAll()" title="Unidad de datos">
    <option value="MB">MB</option>
    <option value="GB" selected>GB</option>
    <option value="TB">TB</option>
  </select>
  <button onclick="applyFilters()">Aplicar</button>
  <button onclick="resetFilters()">Limpiar filtros</button>
  <button onclick="exportPDF()">Exportar PDF</button>
</div>

<div class="flex">
  <div class="kpi"><span>Ejecuciones</span><h2 id="kpiRuns">0</h2></div>
  <div class="kpi"><span>Archivos Copiados</span><h2 id="kpiFiles">0</h2></div>
  <div class="kpi"><span>Datos Transferidos</span><h2 id="kpiBytes">0</h2></div>
  <div class="kpi"><span>Clientes Cr√≠ticos</span><h2 id="kpiCrit">0</h2></div>
</div>

<div class="card">
  <h3>Estado de backups por cliente (OK vs Cr√≠tico)</h3>
  <canvas id="statusClientChart"></canvas>
</div>

<div class="card">
  <h3 id="statusDetailTitle">Detalle por estado</h3>
  <div class="historico-wrapper" style="max-height:340px">
    <table class="historico-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Tarea</th>
          <th>Estado</th>
          <th>D√≠as sin copia</th>
          <th>Archivos</th>
          <th>Bytes</th>
        </tr>
      </thead>
      <tbody id="statusDetailBody"></tbody>
    </table>
  </div>
</div>


<div class="card"><h3>Backups por d√≠a</h3><canvas id="runsDayChart"></canvas></div>
<div class="card"><h3>Bytes copiados por d√≠a</h3><canvas id="bytesDayChart"></canvas></div>
<div class="card"><h3>Ejecuciones por cliente</h3><canvas id="runsClientChart"></canvas></div>
<div class="card"><h3>Duraci√≥n promedio por cliente (min)</h3><canvas id="durationClientChart"></canvas></div>
<div class="card"><h3>Bytes copiados por cliente</h3><canvas id="bytesClientChart"></canvas></div>


<div class="card">
  <h3>Top 10 copias m√°s grandes</h3>
  <table class="table-top10">
    <thead>
      <tr>
        <th>#</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Datos Copiados</th>
      </tr>
    </thead>
    <tbody id="top10Body"></tbody>
  </table>
</div>

<div class="card">
  <h3>Comparador de periodos</h3>
  <div class="flex">
    <div>
      <label>Periodo A</label><br>
      <input type="date" id="cmpAFrom">
      <input type="date" id="cmpATo">
    </div>

    <div>
      <label>Periodo B</label><br>
      <input type="date" id="cmpBFrom">
      <input type="date" id="cmpBTo">
    </div>

    <button onclick="renderComparison()">Comparar</button>
  </div>

  <canvas id="compareChart"></canvas>
</div>



<div class="card">
  <h3>Hist√≥rico</h3>
  <div class="historico-wrapper">
    <table class="historico-table">
  <thead id="csvHead"></thead>
  <tbody id="csvBody"></tbody>
</table>

  </div>
</div>


</div>

<script>
/* ========= CONFIG ========= */
Chart.defaults.devicePixelRatio = 2; // balance calidad / peso

let raw = [], data = [], charts = {};


// ===== FONDO OSCURO PARA EXPORTACI√ìN (PDF / PNG) =====
Chart.register({
  id: 'darkBackground',
  beforeDraw: (chart) => {
    const ctx = chart.ctx;
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#0b1220';
    ctx.fillRect(0, 0, chart.width, chart.height);
    ctx.restore();
  }
});

/* ========= HELPERS ========= */
function normalizeDate(v){
  const d = new Date(v);
  return isNaN(d) ? v.slice(0,10) : d.toISOString().slice(0,10);
}

function durationToSeconds(v){
  if(!v) return 0;
  if(!isNaN(v)) return Number(v);
  const p = v.split(':').map(Number);
  return p.length === 3
    ? p[0]*3600 + p[1]*60 + p[2]
    : p.length === 2
      ? p[0]*60 + p[1]
      : 0;
}

function parseCSVLine(l){
  return l
    .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
    .map(v => v.replace(/^"|"$/g,''));
}


/* ========= CSV ========= */
function loadCSV(e){
  raw=[];
  Promise.all([...e.target.files].map(f=>f.text())).then(txts=>{
    txts.forEach(t=>{
      const lines=t.split(/\r?\n/).filter(Boolean);
      const headers=parseCSVLine(lines[0]);
      lines.slice(1).forEach(l=>{
        const v=parseCSVLine(l),o={};
        headers.forEach((h,i)=>{
          o[h]=v[i];
          if(h==='Fecha') o[h]=normalizeDate(v[i]);
        });
        raw.push(o);
      });
    });
    initFilters(); applyFilters();
  });
}

/* ========= FILTROS ========= */
function initFilters() {
  // CLIENTES
  const clientes = [...new Set(raw.map(r => r.Cliente))];
  filterClient.innerHTML =
    '<option value="">Todos los clientes</option>' +
    clientes.map(c => `<option>${c}</option>`).join('');

  // TAREAS (inicialmente todas)
  initTaskFilter(raw);

  // TIPOS DE COPIA (inicialmente todos)
  initCopyTypeFilter(raw);
}


function applyFilters() {
  data = raw.filter(r => {

    if (filterClient.value && r.Cliente !== filterClient.value) return false;
    if (filterTask.value && r.Tarea !== filterTask.value) return false;
    if (filterCopyType.value && r.TipoCopia !== filterCopyType.value) return false;

    if (fromDate.value && r.Fecha < fromDate.value) return false;
    if (toDate.value && r.Fecha > toDate.value) return false;

    return true;
  });

  renderAll();
}


function resetFilters(){
  // Limpiar valores
  filterClient.value = '';
  filterTask.value = '';
  filterCopyType.value = '';
  fromDate.value = '';
  toDate.value = '';

  // Reconstruir selects dependientes
  initTaskFilter(raw);
  initCopyTypeFilter(raw);

  // Reaplicar filtros (ahora s√≠ limpios)
  applyFilters();
}


function initTaskFilter(source) {
  const tareas = [...new Set(source.map(r => r.Tarea).filter(Boolean))];
  filterTask.innerHTML =
    '<option value="">Todas las tareas</option>' +
    tareas.map(t => `<option>${t}</option>`).join('');
}

function initCopyTypeFilter(source) {
  const tipos = [...new Set(source.map(r => r.TipoCopia).filter(Boolean))];
  filterCopyType.innerHTML =
    '<option value="">Todos los tipos de copia</option>' +
    tipos.map(t => `<option>${t}</option>`).join('');
}

filterClient.addEventListener('change', () => {
  const client = filterClient.value;

  const subset = client
    ? raw.filter(r => r.Cliente === client)
    : raw;

  initTaskFilter(subset);
  initCopyTypeFilter(subset);
});

filterTask.addEventListener('change', () => {
  const task = filterTask.value;
  const client = filterClient.value;

  let subset = raw;

  if (client) subset = subset.filter(r => r.Cliente === client);
  if (task) subset = subset.filter(r => r.Tarea === task);

  initCopyTypeFilter(subset);
});


/* ========= RENDER ========= */
function renderAll(){
  renderKPIs(); renderCharts();renderStatusClientChart(); renderTable(); renderTop10();
}

function renderKPIs(){
  const u=unitSelect.value,f={MB:1024**2,GB:1024**3,TB:1024**4}[u];
  kpiRuns.textContent=data.length;
  kpiFiles.textContent=data.reduce((s,r)=>s+Number(r.ArchivosCopiados||0),0);
  kpiBytes.textContent=(data.reduce((s,r)=>s+Number(r.BytesCopiados||0),0)/f).toFixed(2)+' '+u;
  kpiCrit.textContent=[...new Set(data.filter(r=>r.Estado!=='OK'||Number(r.DiasSinCopia)>=3).map(r=>r.Cliente))].length;
}



function renderStatusClientChart() {

  const ok = {};
  const crit = {};

  data.forEach(r => {
    const c = r.Cliente || 'Desconocido';
    const isCrit =
      (r.Estado || '').toUpperCase() !== 'OK' ||
      Number(r.DiasSinCopia || 0) >= 3;

    if (isCrit) crit[c] = (crit[c] || 0) + 1;
    else ok[c] = (ok[c] || 0) + 1;
  });

  const clientes = Array.from(new Set([
    ...Object.keys(ok),
    ...Object.keys(crit)
  ]));

  if (charts.statusClient) charts.statusClient.destroy();

  charts.statusClient = new Chart(statusClientChart, {
    type: 'bar',
    data: {
      labels: clientes,
      datasets: [
        {
          label: 'OK',
          data: clientes.map(c => ok[c] || 0),
          backgroundColor: 'rgba(34,197,94,0.8)'
        },
        {
          label: 'Cr√≠tico',
          data: clientes.map(c => crit[c] || 0),
          backgroundColor: 'rgba(239,68,68,0.85)'
        }
      ]
    },
    options: {
      onClick: (evt, elements) => {
        if (!elements.length) return;

        const el = elements[0];
        const cliente = clientes[el.index];
        const estado = charts.statusClient.data.datasets[el.datasetIndex].label;

        renderStatusDetail(cliente, estado);
      },
      plugins: {
        legend: { labels: { color: '#e5e7eb' } },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.raw} ejecuciones`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#e5e7eb' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#e5e7eb', precision: 0 },
          grid: { color: 'rgba(255,255,255,0.05)' }
        }
      }
    }
  });
}

function renderStatusDetail(cliente, estado) {

  const tbody = document.getElementById('statusDetailBody');
  const title = document.getElementById('statusDetailTitle');
  if (!tbody) return;

  title.textContent = `Detalle ${estado} ‚Äì Cliente: ${cliente}`;

  const unit = unitSelect.value;
  const factor = { MB:1024**2, GB:1024**3, TB:1024**4 }[unit];

  const rows = data.filter(r => {
    if (r.Cliente !== cliente) return false;

    const isCrit =
      (r.Estado || '').toUpperCase() !== 'OK' ||
      Number(r.DiasSinCopia || 0) >= 3;

    return estado === 'Cr√≠tico' ? isCrit : !isCrit;
  });

  if (!rows.length) {
    tbody.innerHTML = `
      <tr class="row-ok">
        <td colspan="8">Sin registros para este estado</td>
      </tr>`;
    return;
  }

  tbody.innerHTML = rows.map((r,i)=>`
    <tr class="${estado === 'Cr√≠tico' ? 'row-critical' : 'row-ok'}">
      <td>${i+1}</td>
      <td>${r.Fecha || ''}</td>
      <td>${r.Cliente}</td>
      <td>${r.Tarea}</td>
      <td>${r.Estado || estado}</td>
      <td style="text-align:center">${r.DiasSinCopia || 0}</td>
      <td style="text-align:right">${r.ArchivosCopiados || 0}</td>
      <td style="text-align:right">
        ${(Number(r.BytesCopiados||0)/factor).toFixed(2)} ${unit}
      </td>
    </tr>
  `).join('');
}


function renderCharts(){
  Object.values(charts).forEach(c=>c&&c.destroy());
  charts={};

  const rd={},bd={},rc={},dc={},bc={};
  data.forEach(r=>{
    rd[r.Fecha]=(rd[r.Fecha]||0)+1;
    bd[r.Fecha]=(bd[r.Fecha]||0)+Number(r.BytesCopiados||0);
    rc[r.Cliente]=(rc[r.Cliente]||0)+1;
	bc[r.Cliente]=(bc[r.Cliente]||0)+Number(r.BytesCopiados||0);
    const s=durationToSeconds(r.Duracion);
    if(s>0)(dc[r.Cliente]=dc[r.Cliente]||[]).push(s);
  });

  charts.runsDay = new Chart(runsDayChart, {
  type: 'bar',
  data: {
    labels: Object.keys(rd),
    datasets: [{ data: Object.values(rd) }]
  },
options: {
  plugins: {
    legend: {
      labels: {
        color: '#e5e7eb',
        font: { size: 14, weight: '600' }
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    },
    y: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    }
  }
}

});

charts.bytesDay = new Chart(bytesDayChart, {
  type: 'line',
  data: {
    labels: Object.keys(bd),
    datasets: [{ data: Object.values(bd) }]
  },
options: {
  plugins: {
    legend: {
      labels: {
        color: '#e5e7eb',
        font: { size: 14, weight: '600' }
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    },
    y: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    }
  }
}

});

charts.runsClient = new Chart(runsClientChart, {
  type: 'pie',
  data: {
    labels: Object.keys(rc),
    datasets: [{ data: Object.values(rc) }]
  },
options: {
  plugins: {
    legend: {
      labels: {
        color: '#e5e7eb',
        font: { size: 14, weight: '600' }
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    },
    y: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    }
  }
}

});

charts.bytesClient = new Chart(bytesClientChart, {
  type: 'bar',
  data: {
    labels: Object.keys(bc),
    datasets: [{ data: Object.values(bc) }]
  },
 options: {
  plugins: {
    legend: {
      labels: {
        color: '#e5e7eb',
        font: { size: 14, weight: '600' }
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    },
    y: {
      ticks: {
        color: '#e5e7eb',
        font: {
          size: 13,
          weight: '500'
        }
      },
      grid: {
        color: 'rgba(255,255,255,0.05)'
      }
    }
  }
}

});

 /* type:'bar',
  data:{
    labels:Object.keys(bc),
    datasets:[{data:Object.values(bc)}]
  }
}); */

charts.durationClient = new Chart(durationClientChart, {
  type: 'bar',
  data: {
    labels: Object.keys(dc),
    datasets: [{
      data: Object.values(dc).map(
        a => a.reduce((x, y) => x + y, 0) / a.length / 60
      )
    }]
  },
  options: {
    plugins: {
      legend: {
        labels: {
          color: '#e5e7eb',
          font: { size: 14, weight: '600' }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          color: '#e5e7eb',
          font: { size: 13, weight: '500' }
        },
        grid: {
          color: 'rgba(255,255,255,0.05)'
        }
      },
      y: {
        ticks: {
          color: '#e5e7eb',
          font: { size: 13, weight: '500' }
        },
        grid: {
          color: 'rgba(255,255,255,0.05)'
        }
      }
    }
  }
});
}

function renderTop10() {
  const tbody = document.getElementById('top10Body');
  if (!tbody) return;

  const unit = unitSelect.value;
  const factor = { MB: 1024**2, GB: 1024**3, TB: 1024**4 }[unit];

  const top10 = [...data]
    .filter(r => Number(r.BytesCopiados) > 0)
    .sort((a, b) => Number(b.BytesCopiados) - Number(a.BytesCopiados))
    .slice(0, 10);

  tbody.innerHTML = top10.map((r, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${r.Fecha}</td>
      <td>${r.Cliente}</td>
      <td>${(Number(r.BytesCopiados) / factor).toFixed(2)} ${unit}</td>
    </tr>
  `).join('');
}


/* ========= TABLE ========= */
function renderTable() {
  if (!data.length) return;

  const hiddenColumns = [
    'Maquina',
    'Usuario',
    'LogPath',
    'ReporteEliminados',
	'LicenciadoA'
  ];

  const orderedColumns = [
    'Fecha',
    'Inicio',
    'Fin',
    'Duracion',
    'Cliente',
    'Tarea',
    'TipoCopia',
    'Estado',
    'ArchivosCopiados',
    'BytesCopiados',
    'ArchivosEliminados',
    'DiasSinCopia'
  ];

  const allColumns = Object.keys(data[0]).filter(
    h => !hiddenColumns.includes(h)
  );

  const headers = [
    ...orderedColumns.filter(h => allColumns.includes(h)),
    ...allColumns.filter(h => !orderedColumns.includes(h))
  ];

  csvHead.innerHTML =
    '<tr>' +
      '<th>#</th>' +
      headers.map(h => `<th>${h}</th>`).join('') +
    '</tr>';

  csvBody.innerHTML = data.map((r, index) => {

    const dias = Number(r.DiasSinCopia || 0);
    const estado = (r.Estado || '').toUpperCase();

    let rowClass = 'row-ok';
    if (estado !== 'OK' || dias >= 3) rowClass = 'row-critical';
    else if (dias === 1 || dias === 2) rowClass = 'row-warning';

    return `
      <tr class="${rowClass}">
        <td>${index + 1}</td>
        ${headers.map(k => `<td>${r[k] ?? ''}</td>`).join('')}
      </tr>
    `;
  }).join('');
}



function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed'; // evita scroll
  textarea.style.opacity = '0';

  document.body.appendChild(textarea);
  textarea.select();

  try {
    document.execCommand('copy');
  } catch (err) {
    alert('No se pudo copiar');
  }

  document.body.removeChild(textarea);
}


function aggregateBytesByClient(from, to) {
  const result = {};

  data.forEach(r => {
    if (from && r.Fecha < from) return;
    if (to && r.Fecha > to) return;

    const cliente = r.Cliente || 'Desconocido';
    result[cliente] = (result[cliente] || 0) + Number(r.BytesCopiados || 0);
  });

  return result;
}

function renderComparison() {
  const aFrom = cmpAFrom.value;
  const aTo   = cmpATo.value;
  const bFrom = cmpBFrom.value;
  const bTo   = cmpBTo.value;

  if (!aFrom || !aTo || !bFrom || !bTo) {
    alert('Selecciona ambos rangos completos');
    return;
  }

  const bytesA = aggregateBytesByClient(aFrom, aTo);
  const bytesB = aggregateBytesByClient(bFrom, bTo);

  const clientes = Array.from(
    new Set([...Object.keys(bytesA), ...Object.keys(bytesB)])
  ).sort();

  const unit = unitSelect.value;
  const factor = { MB: 1024**2, GB: 1024**3, TB: 1024**4 }[unit];

  const dataA = clientes.map(c => (bytesA[c] || 0) / factor);
  const dataB = clientes.map(c => (bytesB[c] || 0) / factor);

  if (charts.compare) charts.compare.destroy();

  charts.compare = new Chart(compareChart, {
    type: 'bar',
    data: {
      labels: clientes,
      datasets: [
        {
          label: `Periodo A (${aFrom} ‚Üí ${aTo})`,
          data: dataA,
          backgroundColor: 'rgba(14,165,233,0.75)'
        },
        {
          label: `Periodo B (${bFrom} ‚Üí ${bTo})`,
          data: dataB,
          backgroundColor: 'rgba(99,102,241,0.75)'
        }
      ]
    },
    options: {
      plugins: {
        legend: { labels: { color: '#e5e7eb' } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.raw.toFixed(2)} ${unit}`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#e5e7eb',
            maxRotation: 45,
            minRotation: 30
          },
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y: {
          ticks: {
            color: '#e5e7eb',
            callback: v => v + ' ' + unit
          },
          grid: { color: 'rgba(255,255,255,0.05)' }
        }
      }
    }
  });
}

function addChartFullPage(pdf, chart, title, subtitle = '') {
  const W = 297, H = 210, M = 15;

  pdf.addPage();

  // üî• FONDO OSCURO (hereda dashboard)
  pdf.setFillColor(11, 18, 32); // rgb de #0b1220
  pdf.rect(0, 0, W, H, 'F');

  // T√≠tulos en claro
  pdf.setTextColor(229, 231, 235); // #e5e7eb
  pdf.setFontSize(14);
  pdf.text(title, M, 20);

  if (subtitle) {
    pdf.setFontSize(11);
    pdf.text(subtitle, M, 28);
  }

  const img = chart.toBase64Image('image/png', 1);

  pdf.addImage(
    img,
    'PNG',
    M,
    35,
    W - M * 2,
    140,
    undefined,
    'NONE'
  );
}



/* ========= PDF ========= */
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF('l','mm','a4',{compress:true});
  const W=297,H=210,M=15;

  function footer(){
    pdf.setFontSize(9);
    pdf.text('Valentin Flores Delgado',W/2,H-14,{align:'center'});
    pdf.text('https://vffd1990-hue.github.io/Backup-Metrics/',W/2,H-8,{align:'center'});
  }

  pdf.setFontSize(18);
  pdf.text('Reporte de Respaldos',W/2,20,{align:'center'});

  pdf.setFontSize(11);
  pdf.text(
    `Cliente: ${filterClient.value||'Todos'}\n`+
    `Periodo: ${fromDate.value||'N/A'} - ${toDate.value||'N/A'}\n`+
    `Generado: ${new Date().toLocaleString()}`,
    M,40
  );

  pdf.text(
    `Ejecuciones: ${kpiRuns.textContent}\n`+
    `Archivos: ${kpiFiles.textContent}\n`+
    `Datos: ${kpiBytes.textContent}\n`+
    `Clientes cr√≠ticos: ${kpiCrit.textContent}`,
    M,75
  );

  footer();

  function chartPage(title,desc,chart,sidebarData=null){
    pdf.addPage();
    pdf.setFontSize(14); pdf.text(title,M,20);
    pdf.setFontSize(11); pdf.text(desc,M,30);

    if(sidebarData){
      let y=45;
      pdf.setFontSize(10);
      sidebarData.forEach(([k,v])=>{
        pdf.text(`${k}: ${v}`,M,y);
        y+=6;
      });
      pdf.addImage(chart.toBase64Image(),'PNG',M+70,40,W-M*2-70,130,undefined,'FAST');
    }else{
      pdf.addImage(chart.toBase64Image(),'PNG',M,40,W-M*2,130,undefined,'FAST');
    }
    footer();
  }

addChartFullPage(
  pdf,
  charts.runsDay,
  'Backups por d√≠a',
  'Ejecuciones diarias'
);

addChartFullPage(
  pdf,
  charts.bytesDay,
  'Bytes copiados por d√≠a',
  'Volumen transferido por fecha'
);

addChartFullPage(
  pdf,
  charts.bytesClient,
  'Bytes copiados por cliente',
  'Distribuci√≥n de datos por cliente'
);


  pdf.save('Reporte_Respaldos.pdf');
}
</script>
</body>
</html>

